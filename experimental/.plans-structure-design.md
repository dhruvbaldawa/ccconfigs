# .plans/ State Management Structure Design

## Overview

Flexible planning structure supporting both simple single-milestone features and complex multi-milestone projects. Agents read/write to shared state documents following the `.plans/<project>/` pattern.

## Directory Structure

### Simple Single-Milestone Project
```
.plans/
â””â”€â”€ user-authentication/
    â”œâ”€â”€ plan.md                    # Main plan document (single source of truth)
    â”œâ”€â”€ tasks/
    â”‚   â”œâ”€â”€ 001-setup-auth-model.md
    â”‚   â”œâ”€â”€ 002-implement-login-endpoint.md
    â”‚   â”œâ”€â”€ 003-add-jwt-middleware.md
    â”‚   â””â”€â”€ 004-write-auth-tests.md
    â””â”€â”€ handoffs.md                # Agent communication log (markdown)
```

### Complex Multi-Milestone Project
```
.plans/
â””â”€â”€ real-time-collaboration/
    â”œâ”€â”€ plan.md                    # Main plan (overview + current milestone)
    â”œâ”€â”€ technical-spec.md          # Technical specifications
    â”œâ”€â”€ architecture.md            # System architecture decisions
    â”œâ”€â”€ milestones.md              # Milestone breakdown
    â”œâ”€â”€ milestones/
    â”‚   â”œâ”€â”€ m1-websocket-foundation/
    â”‚   â”‚   â”œâ”€â”€ tasks/
    â”‚   â”‚   â”‚   â”œâ”€â”€ 001-setup-websocket-server.md
    â”‚   â”‚   â”‚   â””â”€â”€ 002-client-connection-manager.md
    â”‚   â”‚   â””â”€â”€ status.md          # Milestone-specific status
    â”‚   â”œâ”€â”€ m2-operational-transform/
    â”‚   â”‚   â”œâ”€â”€ tasks/
    â”‚   â”‚   â”‚   â”œâ”€â”€ 001-implement-ot-algorithm.md
    â”‚   â”‚   â”‚   â””â”€â”€ 002-conflict-resolution.md
    â”‚   â”‚   â””â”€â”€ status.md
    â”‚   â””â”€â”€ m3-production-deployment/
    â”‚       â””â”€â”€ tasks/
    â”‚           â””â”€â”€ 001-scaling-strategy.md
    â”œâ”€â”€ tasks/                     # Cross-milestone tasks (if any)
    â”‚   â””â”€â”€ 001-setup-monitoring.md
    â””â”€â”€ handoffs.md                # Agent communication log
```

## File Formats

### plan.md (Main Plan Document)

**For Single-Milestone:**
```markdown
# Plan: User Authentication

**Status:** in_progress
**Created:** 2025-01-15
**Last Updated:** 2025-01-16 14:32
**Current Agent:** implementation-agent

## Overview

Implement JWT-based authentication system with login, logout, and protected routes.

## Requirements

- Users can register with email/password
- Users can login and receive JWT token
- Protected routes validate JWT tokens
- Tokens expire after 24 hours

## Architecture Decisions

- Use bcrypt for password hashing
- JWT stored in HTTP-only cookies
- Refresh token pattern for long sessions

## Task Breakdown

### Task 001: Setup Auth Model
**Status:** completed
**Agent:** implementation-agent
**Files:** src/models/User.ts, src/schemas/user.schema.ts
**Completed:** 2025-01-16 10:15

### Task 002: Implement Login Endpoint
**Status:** in_progress
**Agent:** implementation-agent
**Files:** src/routes/auth.ts, src/controllers/authController.ts
**Started:** 2025-01-16 14:20

### Task 003: Add JWT Middleware
**Status:** pending
**Dependencies:** Task 002

### Task 004: Write Auth Tests
**Status:** pending
**Dependencies:** Task 002, Task 003

## Progress

- âœ… 1/4 tasks completed
- ğŸ”„ 1 task in progress
- â³ 2 tasks pending

## Notes

- Review agent flagged security concern in task 002 - need to add rate limiting
```

**For Multi-Milestone:**
```markdown
# Plan: Real-Time Collaboration

**Status:** in_progress
**Created:** 2025-01-10
**Last Updated:** 2025-01-16 14:32
**Current Milestone:** m1-websocket-foundation
**Current Agent:** implementation-agent

## Overview

Build real-time collaborative editing system supporting multiple simultaneous editors with operational transformation for conflict resolution.

## Documents

- [Technical Specification](./technical-spec.md) - Detailed technical requirements
- [Architecture](./architecture.md) - System design and component interactions
- [Milestones](./milestones.md) - Milestone breakdown and dependencies

## Milestone Progress

### âœ… Milestone 0: Planning & Design (completed)
- Technical spec finalized
- Architecture reviewed
- Milestones defined

### ğŸ”„ Milestone 1: WebSocket Foundation (in_progress)
**Tasks:** 2/5 completed
**Status:** [See milestones/m1-websocket-foundation/status.md](./milestones/m1-websocket-foundation/status.md)

### â³ Milestone 2: Operational Transform (pending)
**Dependencies:** M1 completion

### â³ Milestone 3: Production Deployment (pending)
**Dependencies:** M2 completion

## Current Focus

Working on Milestone 1, Task 003: Client connection manager with automatic reconnection.

## Notes

- Architecture review passed with recommendation to add connection pooling
- Testing agent identified need for load testing framework in M3
```

### tasks/<number>-<task>.md (Individual Task Document)

```markdown
# Task 002: Implement Login Endpoint

**Status:** in_progress
**Created By:** planning-agent
**Assigned To:** implementation-agent
**Started:** 2025-01-16 14:20
**Milestone:** (none) | m1-websocket-foundation

## Description

Create POST /api/auth/login endpoint that accepts email/password, validates credentials, and returns JWT token.

## Dependencies

- Task 001 (User model must exist)

## Files to Modify

- `src/routes/auth.ts` - Add login route
- `src/controllers/authController.ts` - Implement login logic
- `src/middleware/validation.ts` - Add login validation schema

## Acceptance Criteria

- [ ] Endpoint accepts email and password
- [ ] Credentials validated against database
- [ ] Password comparison uses bcrypt
- [ ] JWT token generated on success
- [ ] Token stored in HTTP-only cookie
- [ ] Appropriate error responses (401 for invalid credentials)
- [ ] Rate limiting applied (max 5 attempts per minute)

## Implementation Notes

**Planning Agent Notes:**
- Use existing JWT utility from src/utils/jwt.ts
- Error responses should not reveal whether email exists

**Implementation Agent Notes:**
- âœ… Created route and controller structure
- âœ… Added validation middleware
- ğŸ”„ Implementing bcrypt password check
- âš ï¸  Need to add rate limiting (flagged by review agent)

## Validation Results

**Testing Agent:**
- Unit tests written: âœ…
- Integration tests written: â³ (pending)
- Coverage: 85% (target: 90%)

**Review Agent:**
- Security score: 75/100
- Issues: Missing rate limiting, consider adding 2FA hooks
- Blocking: No

## Handoffs

1. **planning-agent â†’ implementation-agent** (2025-01-16 14:20)
   - Context: Task created, ready for implementation

2. **implementation-agent â†’ review-agent** (2025-01-16 15:45)
   - Context: Initial implementation complete, requesting security review

3. **review-agent â†’ implementation-agent** (2025-01-16 16:10)
   - Context: Security concern - add rate limiting before marking complete
```

### milestones.md (Milestone Breakdown)

```markdown
# Milestones: Real-Time Collaboration

## Overview

Project broken into 3 major milestones with clear deliverables and dependencies.

## Milestone 1: WebSocket Foundation

**Duration:** 2 weeks
**Dependencies:** None
**Status:** in_progress

**Objectives:**
- Establish WebSocket server infrastructure
- Client connection management with auto-reconnect
- Basic message broadcasting

**Tasks:** 5 total
- Task 001: Setup WebSocket server
- Task 002: Client connection manager
- Task 003: Message serialization
- Task 004: Connection pooling
- Task 005: Basic broadcast functionality

**Deliverables:**
- Working WebSocket server
- Client SDK with connection management
- 90%+ test coverage

**Exit Criteria:**
- [ ] 100 concurrent connections tested
- [ ] Auto-reconnect works reliably
- [ ] All tests passing
- [ ] Architecture review approved

## Milestone 2: Operational Transform

**Duration:** 3 weeks
**Dependencies:** M1 complete
**Status:** pending

**Objectives:**
- Implement OT algorithm
- Conflict resolution system
- Multi-user editing support

**Tasks:** 8 total (detailed in milestones/m2-operational-transform/)

**Deliverables:**
- OT engine
- Conflict resolution
- Multi-user test suite

**Exit Criteria:**
- [ ] 10 simultaneous editors tested
- [ ] Convergence guaranteed
- [ ] Performance benchmarks met (<100ms latency)

## Milestone 3: Production Deployment

**Duration:** 1 week
**Dependencies:** M2 complete
**Status:** pending

**Objectives:**
- Horizontal scaling strategy
- Monitoring and observability
- Production deployment

**Tasks:** 4 total (detailed in milestones/m3-production-deployment/)

**Deliverables:**
- Deployment documentation
- Monitoring dashboards
- Load testing results

**Exit Criteria:**
- [ ] 1000 concurrent users tested
- [ ] 99.9% uptime SLA
- [ ] Monitoring in place
```

### handoffs.md (Agent Communication Log)

```markdown
# Agent Handoffs: User Authentication

## 2025-01-16 14:20 - planning-agent â†’ implementation-agent

**Task:** 002-implement-login-endpoint
**Context:** Task created and ready for implementation

**From Planning Agent:**
Initial breakdown complete. Login endpoint needs JWT generation and bcrypt password validation. User model already exists from Task 001.

**To Implementation Agent:**
Please implement the login endpoint per the task specification. Pay special attention to security - use bcrypt for password comparison and don't reveal in error messages whether the email exists.

---

## 2025-01-16 15:45 - implementation-agent â†’ review-agent

**Task:** 002-implement-login-endpoint
**Context:** Initial implementation complete, requesting security review

**From Implementation Agent:**
Login endpoint implemented with:
- Email/password validation
- Bcrypt password verification
- JWT token generation
- HTTP-only cookie storage
- Error handling

**Files Changed:**
- src/routes/auth.ts
- src/controllers/authController.ts
- src/middleware/validation.ts

**To Review Agent:**
Please review for security vulnerabilities, especially around authentication logic.

---

## 2025-01-16 16:10 - review-agent â†’ implementation-agent

**Task:** 002-implement-login-endpoint
**Context:** Security review complete - changes required

**From Review Agent:**
Security Score: 75/100

**Issues Found:**
- âš ï¸  Missing rate limiting (prevents brute force attacks)
- â„¹ï¸  Consider adding hooks for 2FA in future
- âœ… Password handling secure
- âœ… JWT generation correct
- âœ… Error messages don't leak information

**Recommendation:** Add rate limiting before marking task complete.

**To Implementation Agent:**
Please add rate limiting (max 5 login attempts per minute per IP) to address the security concern.

---

## 2025-01-16 16:45 - implementation-agent â†’ testing-agent

**Task:** 002-implement-login-endpoint
**Context:** Rate limiting added, ready for testing

**From Implementation Agent:**
Rate limiting implemented using express-rate-limit middleware. All security concerns addressed.

**To Testing Agent:**
Please write comprehensive tests covering:
- Valid login succeeds
- Invalid password fails with 401
- Non-existent email fails with 401
- Rate limiting blocks after 5 attempts
- JWT token properly generated
```

## Decision Rules

### When to Create Multiple Milestones

**Use Multi-Milestone Structure When:**
- Project duration > 2 weeks
- More than 10 tasks total
- Clear phase dependencies (foundation â†’ features â†’ deployment)
- Multiple distinct deliverables
- Requires architectural planning documents

**Use Single-Milestone Structure When:**
- Project duration < 2 weeks
- Fewer than 10 tasks
- Single cohesive feature
- No architectural complexity
- Straightforward implementation

### Planning Agent Decision Flow

```
Planning Agent receives request
    â†“
Analyze complexity:
    - Task count estimation
    - Technical complexity
    - Dependencies
    â†“
IF (tasks > 10 OR duration > 2 weeks OR needs architecture docs):
    Create .plans/<project>/
        - plan.md (multi-milestone format)
        - milestones.md
        - technical-spec.md (if complex)
        - architecture.md (if complex)
        - milestones/m1-<name>/, m2-<name>/, etc.
ELSE:
    Create .plans/<project>/
        - plan.md (single-milestone format)
        - tasks/
        - handoffs.md
```

## State Transitions

### Task Status Flow
```
pending â†’ in_progress â†’ (review) â†’ completed
           â†“
         blocked (if dependencies fail)
```

### Milestone Status Flow
```
pending â†’ in_progress â†’ (validation) â†’ completed
           â†“
         blocked (if critical task fails)
```

### Agent Coordination Flow
```
planning-agent: Creates .plans/<project>/ structure
    â†“
implementation-agent: Picks tasks, updates status
    â†“
review-agent: Reviews completed tasks, provides feedback
    â†“
testing-agent: Writes tests, validates acceptance criteria
    â†“
(loop back to implementation if issues found)
    â†“
Task marked completed when all agents approve
```

## Agent Responsibilities

### Planning Agent
- **Reads:** Requirements from user
- **Writes:**
  - plan.md (creates structure)
  - milestones.md (if multi-milestone)
  - technical-spec.md (if needed)
  - architecture.md (if needed)
  - tasks/*.md (creates all task files)
- **Never:** Modifies code files

### Implementation Agent
- **Reads:**
  - plan.md (current task)
  - tasks/<current>.md (acceptance criteria)
  - Code files
- **Writes:**
  - tasks/<current>.md (implementation notes, status updates)
  - Code files (actual implementation)
  - handoffs.md (when requesting review/testing)
- **Never:** Changes task acceptance criteria or creates new tasks

### Review Agent
- **Reads:**
  - tasks/<current>.md (what was implemented)
  - Code files (what changed)
  - handoffs.md (context from implementation agent)
- **Writes:**
  - tasks/<current>.md (validation results, scores, issues)
  - handoffs.md (feedback to implementation agent)
- **Never:** Modifies code files

### Testing Agent
- **Reads:**
  - tasks/<current>.md (acceptance criteria)
  - Code files (implementation to test)
- **Writes:**
  - Test files (unit/integration/e2e based on granularity decision)
  - tasks/<current>.md (test results, coverage metrics)
  - handoffs.md (test status)
- **Behavior:**
  - Creates test scenarios first (behavior-focused, not logic-focused)
  - Chooses appropriate granularity (unit/integration/e2e) based on system under test
  - Prevents excessive and useless tests

## File Conventions

### Naming
- Projects: `kebab-case` (e.g., `user-authentication`)
- Tasks: `<number>-<kebab-case>.md` (e.g., `001-setup-auth-model.md`)
- Milestones: `m<number>-<kebab-case>` (e.g., `m1-websocket-foundation`)

### Status Values
- `pending` - Not started
- `in_progress` - Currently being worked on
- `blocked` - Cannot proceed (dependency issue)
- `completed` - Done and validated

### Agent Names
- `planning-agent`
- `implementation-agent`
- `review-agent`
- `testing-agent`

## Examples of Handoff Communication

### Good Handoff (Specific Context)
```markdown
## 2025-01-16 14:20 - planning-agent â†’ implementation-agent

**Task:** 002-implement-login-endpoint
**Context:** Task created and ready for implementation

Initial breakdown complete. Login endpoint needs JWT generation and bcrypt
password validation. User model already exists from Task 001. Pay special
attention to not revealing in error messages whether email exists.
```

### Bad Handoff (Too Vague)
```markdown
## 2025-01-16 14:20 - planning-agent â†’ implementation-agent

Task 002 is ready. Please implement.
```

### Good Handoff (Review Feedback)
```markdown
## 2025-01-16 16:10 - review-agent â†’ implementation-agent

**Task:** 002-implement-login-endpoint
**Context:** Security review complete - changes required

Security Score: 75/100

**Issues:**
- âš ï¸  Missing rate limiting (OWASP A07:2021 - prevents brute force)
- âœ… Password handling secure

**Action Required:** Add express-rate-limit middleware with 5 requests/minute limit.
```

---

## Summary

This structure provides:

âœ… **Flexibility** - Scales from simple features to complex projects
âœ… **Single Source of Truth** - plan.md always reflects current state
âœ… **Agent Coordination** - Clear handoff protocol via handoffs.md
âœ… **Milestone Support** - Both single and multi-milestone patterns
âœ… **Transparency** - All agent communications logged
âœ… **State Management** - Task status flows through defined transitions

The structure adapts to project complexity while maintaining consistent patterns for agent coordination.
