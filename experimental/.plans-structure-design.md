# .plans/ Structure Design (Kanban Flow)

## Core Concept

Task files physically move between agent directories, simulating a Kanban board. File location = current owner. No separate status tracking needed.

## Directory Structure

### Simple Project

```
.plans/user-authentication/
├── plan.md                  # Overview, architecture decisions
├── pending/                 # Tasks ready to be picked up
│   ├── 001-setup-user-model.md
│   └── 002-login-endpoint.md
├── implementation/          # Currently being coded
│   └── 003-jwt-middleware.md
├── review/                  # Awaiting code review
│   └── 004-rate-limiting.md
├── testing/                 # Awaiting tests
│   └── 005-password-reset.md
└── completed/               # Done
    └── 006-documentation.md
```

### Multi-Milestone Project

```
.plans/realtime-collab/
├── plan.md                  # High-level overview
├── milestones.md            # Milestone breakdown
├── technical-spec.md        # Detailed specs (if complex)
├── architecture.md          # Design decisions (if complex)
├── pending/
│   └── m1-001-websocket-server.md
├── implementation/
│   └── m1-002-connection-manager.md
├── review/
├── testing/
└── completed/
    └── m1-003-message-broadcast.md
```

## Task Flow (Kanban)

```
pending → implementation → review → testing → completed
            ↓                 ↓
            └─────────────────┘ (rejection: back to implementation)
```

**Agent Actions:**
1. **Implementation agent:** `mv pending/002-*.md implementation/`
2. **Work:** Edits code, appends notes to task file
3. **Handoff:** `mv implementation/002-*.md review/`
4. **Review agent:** Finds task in `review/`, evaluates
5. **If rejected:** `mv review/002-*.md implementation/` (back!)
6. **If approved:** `mv review/002-*.md testing/`
7. **Testing agent:** `mv testing/002-*.md testing/` (claim), writes tests
8. **Complete:** `mv testing/002-*.md completed/`

## File Formats

### plan.md

```markdown
# Plan: User Authentication

## Overview
JWT-based auth with login, logout, protected routes.

## Requirements
- Users can login with email/password
- JWT tokens with 24h expiry
- Rate limiting on auth endpoints

## Architecture
- Bcrypt for password hashing
- JWT in HTTP-only cookies
- Refresh token pattern

## Tasks
See agent directories for current status:
- `pending/`: 2 tasks
- `implementation/`: 1 task
- `review/`: 0 tasks
- `testing/`: 1 task
- `completed/`: 3 tasks

Total: 7 tasks
```

No status tracking in plan.md. Derive from directories.

### Task File (001-setup-user-model.md)

```markdown
# Task 001: Setup User Model

**Dependencies:** None
**Files:** src/models/User.ts, src/schemas/user.schema.ts

## Description
Create User model with email and passwordHash fields. Use bcrypt for hashing.

## Acceptance
- [ ] User model with email, passwordHash
- [ ] Email validation
- [ ] Bcrypt integration (salt rounds: 10)
- [ ] Password minimum 8 characters

## Notes

**planning-agent:** Follow existing model patterns in src/models/

**implementation-agent:** Created User model with Joi validation. Bcrypt integrated. All tests passing.

**review-agent:**
Security: 95/100 | Quality: 90/100 | Performance: 100/100
Approved → testing

**testing-agent:**
12 tests written (unit: model validation, integration: bcrypt)
Coverage: 96%
All passing → completed
```

**Key:** Agents append notes. No separate status field (location = status).

## Agent Workflows

### Planning Agent

1. Creates `.plans/<project>/` structure
2. Creates plan.md, milestones.md (if multi-milestone)
3. Creates all task files in `pending/`
4. Done (doesn't move files)

### Implementation Agent

1. Globs `pending/` directory
2. Finds task with no dependencies (or dependencies in `completed/`)
3. `mv pending/001-task.md implementation/001-task.md`
4. Implements feature, edits code files
5. Appends implementation notes to task file
6. `mv implementation/001-task.md review/001-task.md`

### Review Agent

1. Globs `review/` directory
2. For each task file:
   - Reads task, checks changed files
   - Performs security/quality/performance review
   - Appends scores and findings to task file
3. **If approved:** `mv review/001-task.md testing/001-task.md`
4. **If rejected:** `mv review/001-task.md implementation/001-task.md`

### Testing Agent

1. Globs `testing/` directory
2. For each task file:
   - Reads task and implementation
   - Designs test scenarios
   - Writes tests (unit/integration/e2e based on system)
   - Runs tests, checks coverage
   - Appends test results to task file
3. `mv testing/001-task.md completed/001-task.md`

## Progress Tracking (Derived)

```bash
pending=$(find .plans/project/pending -name "*.md" | wc -l)
implementation=$(find .plans/project/implementation -name "*.md" | wc -l)
review=$(find .plans/project/review -name "*.md" | wc -l)
testing=$(find .plans/project/testing -name "*.md" | wc -l)
completed=$(find .plans/project/completed -name "*.md" | wc -l)
total=$((pending + implementation + review + testing + completed))

echo "Progress: $completed/$total completed"
```

No manual counter updates. File location = source of truth.

## Benefits

1. **Visual Kanban:** `ls -la .plans/project/*/` shows current state
2. **O(1) Task Discovery:** Agent globs only their directory
3. **No Redundant State:** File location = status
4. **Atomic Handoffs:** `mv` is atomic operation
5. **Git History:** Full task journey visible in git log
6. **Natural Rejection:** Moving back is explicit
7. **Parallelization:** Multiple tasks in same directory can run concurrently
